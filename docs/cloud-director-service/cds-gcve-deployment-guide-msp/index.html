<!doctype html><html lang=en-us dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Introduction #  This white paper is intended for VCPP Cloud Providers who need guidance on how to configure Google Cloud VMware Engine with VMware Cloud Director service (CDs). The content below describes the manual deployment process required to setup the Google Cloud projects, configure them, deploy a Software Defined Data Center (SDDC), associate it to CDs, and the process to configure a virtual private network (VPN) solution for connectivity to isolated networks.">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="VMware Cloud Director Service for Google Cloud VMware Engine Deployment Guide">
<meta property="og:description" content="Introduction #  This white paper is intended for VCPP Cloud Providers who need guidance on how to configure Google Cloud VMware Engine with VMware Cloud Director service (CDs). The content below describes the manual deployment process required to setup the Google Cloud projects, configure them, deploy a Software Defined Data Center (SDDC), associate it to CDs, and the process to configure a virtual private network (VPN) solution for connectivity to isolated networks.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://vcpat.cloudhappens.io/docs/cloud-director-service/cds-gcve-deployment-guide-msp/"><meta property="article:section" content="docs">
<meta property="article:modified_time" content="2022-11-11T13:03:35+05:30">
<title>VMware Cloud Director Service for Google Cloud VMware Engine Deployment Guide | VMware Cloud Provider Architecture Toolkit</title>
<link rel=manifest href=/manifest.json>
<link rel=icon href=/favicon.png type=image/x-icon>
<link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous>
<script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.8536767d6cc736211b280b20dde2cf621ba26dde04401cd6255a0606fbf1753a.js integrity="sha256-hTZ2fWzHNiEbKAsg3eLPYhuibd4EQBzWJVoGBvvxdTo=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/><span>VMware Cloud Provider Architecture Toolkit</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
<ul>
<li><a href=/feedback/><em>Feedback</em></a></li>
</ul>
<h2 id=draft-validated-solutions>
Draft Validated Solutions:
<a class=anchor href=#draft-validated-solutions>#</a>
</h2>
<ul>
<li><a href=/docs/cloud-infrastructure/><strong>Cloud Infrastructure</strong></a>
<ul>
<li><a href=/docs/cloud-infrastructure/planning/>Planning and Preparation</a></li>
<li><a href=/docs/cloud-infrastructure/design/>Design Objectives</a></li>
<li><a href=/docs/cloud-infrastructure/detailed-design/>Detailed Design</a></li>
<li><a href=/docs/cloud-infrastructure/implementation/>Implementation</a></li>
<li><a href=/docs/cloud-infrastructure/operations/>Operational Guidance</a></li>
<li><a href=/docs/cloud-infrastructure/design-decisions/>Design Decisions</a></li>
<li><a href=/docs/cloud-infrastructure/solution-interop/>Solution Interoperability</a></li>
</ul>
</li>
<li><a href=/docs/dr-migration/><strong>DR and Migration</strong></a>
<ul>
<li><a href=/docs/dr-migration/planning/>Planning and Preparation</a></li>
<li><a href=/docs/dr-migration/design/>Design Objectives</a></li>
<li><a href=/docs/dr-migration/detailed-design/>Detailed Design</a></li>
<li><a href=/docs/dr-migration/implementation/>Implementation</a></li>
<li><a href=/docs/dr-migration/operations/>Operational Guidance</a></li>
</ul>
</li>
<li><a href=/docs/developer-ready-cloud/><strong>Developer Ready Cloud</strong></a>
<ul>
<li><a href=/docs/developer-ready-cloud/planning/>Planning and Preparation</a></li>
<li><a href=/docs/developer-ready-cloud/design/>Design Objectives</a></li>
<li><a href=/docs/developer-ready-cloud/detailed-design/>Detailed Design</a></li>
<li><a href=/docs/developer-ready-cloud/implementation/>Implementation</a></li>
<li><a href=/docs/developer-ready-cloud/operations/>Operational Guidance</a></li>
</ul>
</li>
<li><a href=/docs/sovereign-cloud/><strong>Sovereign Cloud</strong></a>
<ul>
<li><a href=/docs/sovereign-cloud/planning/>Planning and Preparation</a></li>
<li><a href=/docs/sovereign-cloud/design/>Design Objectives</a></li>
<li><a href=/docs/sovereign-cloud/detailed-design/>Detailed Design</a></li>
<li><a href=/docs/sovereign-cloud/implementation/>Implementation</a></li>
<li><a href=/docs/sovereign-cloud/operations/>Operational Guidance</a></li>
</ul>
</li>
</ul>
<h2 id=toolkit-documents>
Toolkit Documents:
<a class=anchor href=#toolkit-documents>#</a>
</h2>
<ul>
<li><strong>VMware Cloud Provider Lifecycle Manager</strong></li>
<li><a href=/docs/cloud-director/><strong>VMware Cloud Director</strong></a>
<ul>
<li>Automation</li>
<li>Branding & Themes</li>
<li>Extensibility</li>
<li><a href=/docs/cloud-director/identity-access/>Identity & Access</a></li>
<li>Multi-site</li>
<li>Networking</li>
<li>Scale</li>
<li>Security</li>
</ul>
</li>
<li><strong>VMware Cloud Director service</strong>
<ul>
<li><a href=/docs/cloud-director-service/implementation/>Implementation</a></li>
</ul>
</li>
<li><strong>VMware Cloud Director Availability</strong></li>
<li><strong>VMware vCloud Usage Meter</strong></li>
<li><strong>VMware Cloud Director Container Service Extension</strong></li>
<li><strong>VMware Cloud Director Oject Storage Extension</strong></li>
<li><strong>VMware Cloud Director Application Launchpad</strong>
<br></li>
</ul>
<ul>
<li>
<a href=https://cloudsolutions.vmware.com target=_blank rel=noopener>
VMware Cloud Solutions
</a>
</li>
</ul>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>VMware Cloud Director Service for Google Cloud VMware Engine Deployment Guide</strong>
<label for=toc-control>
</label>
</div>
</header>
<article class=markdown><h1 id=introduction>
Introduction
<a class=anchor href=#introduction>#</a>
</h1>
<p>This white paper is intended for VCPP Cloud Providers who need guidance
on how to configure Google Cloud VMware Engine with VMware Cloud
Director service (CDs). The content below describes the manual
deployment process required to setup the Google Cloud projects,
configure them, deploy a Software Defined Data Center (SDDC), associate
it to CDs, and the process to configure a virtual private network (VPN)
solution for connectivity to isolated networks.</p>
<p>A virtual private network (VPN) provides traffic tunneling through an
encrypted connection, preventing it from being seen or modified in
transit. VMware NSXÂ® Data Center for vSphere includes a remote access
VPN feature (IPsec) that allows the connection from a remote site to
connect securely to the private networks and applications in the
organization virtual data center.</p>
<p>Due to a limitation in VPN technology in Google Cloud, the provider will
need to select an alternative solution such as an open source or
commercially available, depending on the required features and available
support. Examples of open source solutions include OpenVPN or
StrongSwan. This deployment guide will walk through the steps required
to implement the StrongSwan solution to provide the VPN connectivity
between the provider-managed customer project and the T1 edge that sits
in front of the tenant networks. The VPN solution is deployed and
configured manually in addition to being managed separately from CDs.</p>
<p>Disclamer</p>
<p>VMware does not endorse, recommend, or support any third-party utility
or solution.</p>
<p>A general knowledge of networking and security, as well as on VMware
Cloud Director concepts is also required.</p>
<h2 id=configure-provider-project-and-create-required-resources>
Configure Provider Project and Create Required Resources
<a class=anchor href=#configure-provider-project-and-create-required-resources>#</a>
</h2>
<p>The following section describes the steps required to setup the cloud
provider project. Before proceeding, the projects should be created, and
the account used to configure them have the appropriate permission to
configure all aspects of the projects.</p>
<h3 id=setup-the-provider-project>
Setup the Provider Project
<a class=anchor href=#setup-the-provider-project>#</a>
</h3>
<p>The following steps describes the steps required to configure the
provider project.</p>
<ul>
<li>Log into the Google Cloud console and click &ldquo;Select a project&rdquo;
dropdown.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve1.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>On the &ldquo;Select a project&rdquo; box, click the link for the name of the
provider project.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve2.png alt="Graphical user interface, text, application, email Description
automatically generated"></p>
</blockquote>
<ul>
<li>In the top left pane, click the three horizontal bars and navigate
down to Network -> Network Services -> and click Cloud DNS.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve3.png alt="Graphical user interface, application, Word Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>If prompted to enable the API first, click Enable API.</p>
</li>
<li>
<p>In the top left pane, click the three horizontal bars and navigate
down to Compute -> and select VMware Engine. Note that this will
open a second browser tab, keep both tabs open for easier navigating
when configuring later.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve4.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Click Enable API.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve5.png alt="Text Description automatically generated with medium
confidence"></p>
</blockquote>
<ul>
<li>In the top left pane click the three horizontal bars and navigate to
Networking -> VPC Network -> and select VPC Networks.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve6.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Click CREATE VPC NETWORK.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve7.png alt="Graphical user interface, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter in the following:</p>
<ul>
<li>
<p>Name: Subnet name such as the region the environment is in such
as &ldquo;asia-southeast1&rdquo;</p>
</li>
<li>
<p>Region: Select the region the environment is in to host the
subnet such as &ldquo;asia-southeast1&rdquo;</p>
</li>
<li>
<p>IP Address Range: Provide a range such as 100.64.0.0/20</p>
</li>
<li>
<p>Check the box for &ldquo;I confirm that my subnet configuration
includes a range outside of the RFC 1918 address space&rdquo;</p>
</li>
<li>
<p>Private Google Access: Select the ON radial button</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve8.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Under Dynamic Routing Mode:</p>
<ul>
<li>
<p>Select Global</p>
</li>
<li>
<p>Set the Maximum MTU to 1500</p>
</li>
<li>
<p>Click Create</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve9.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Once the task has completed, scroll to the bottom of the page, and
click the name of the provider management network that was just
created.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve10.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>In the VPC network details screen, click the PRIVATE SERVICE
CONNECTION tab and click the Enable API Button.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve11.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Once enabled, click ALLOCATE IP RANGE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve12.png alt="Graphical user interface, text Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>For Allocate an internal IP range enter:</p>
<ul>
<li>
<p>Name: service-network</p>
</li>
<li>
<p>IP Range: The next subnet available in the provider range
previously entered, 100.64.16.0/24 in this case</p>
</li>
<li>
<p>Click ALLOCATE</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve140.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Click the PRIVATE CONNECTIONS TO SERVICES tab and click CREATE
CONNECTION.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve14.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>On the private connection screen, ensure Google Cloud Platform is
selected and select the service-network that was created under
Assigned Allocation and click Connect.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve15.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<h3 id=create-and-configure-the-software-defined-data-center>
Create and Configure the Software Defined Data Center
<a class=anchor href=#create-and-configure-the-software-defined-data-center>#</a>
</h3>
<p>The following section describes the steps required to setup the Software
Defined Data Center (SDDC) that tenants will consume for resources.</p>
<ul>
<li>Go to the browser tab that has GCVE open and click Create a Private
Cloud.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve16.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following information:</p>
<ul>
<li>
<p>Private Cloud Name: Name of the SDDC to create</p>
</li>
<li>
<p>Location: The GCP data center to create the SDDC</p>
</li>
<li>
<p>Node Type: Multi Node for production deployments</p>
</li>
<li>
<p>Node Count: Number of nodes to initially use for the SDDC (4
minimum)</p>
</li>
<li>
<p>vSphere/vSAN Range: IP range to use for vSphere and vSAN</p>
</li>
<li>
<p>HCX Deployment Range: IP range to use for HCX (while the input
is required, using HCX is not required)</p>
</li>
<li>
<p>Click Review and Create when ready</p>
<ul>
<li><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve17.png alt="Graphical user interface, application Description
automatically
generated"></li>
</ul>
</li>
<li>
<p>Click Create</p>
</li>
<li>
<p>The SDDC creation process takes around one hour to complete.</p>
</li>
</ul>
</li>
<li>
<p>Once the SDDC completion process works, the next steps are completed
most easily by have two browser tabs open: one for the GCVE
environment and one on the provider project settings.</p>
</li>
<li>
<p>On the browser tab with GCVE, in the left pane click Network and in
the right pane click Add Private Connection.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve18.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following information:</p>
<ul>
<li>
<p>Service: VPC Network</p>
</li>
<li>
<p>Region: The region the SDDC was created in</p>
</li>
<li>
<p>Peer Project ID: this will be the provider project name, which
can be found in the browser tab with the provider project by
clicking Google Cloud Platform and then copying the Project Name
field and pasting it into the Peer Project ID field</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve19.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Peer Project Number: This is the project ID, which can be found in
the tab where the Project Name filed is immediately under that; copy
and paste the value into the Peer Project Number field</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve20.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Peer VPC ID: This will be &ldquo;provider-mgmt-network&rdquo; unless it was
named differently. If it was name differently, enter the name used.</p>
</li>
<li>
<p>Tenant Project ID: To get the tenant project ID value, on the
browser tab with the provider project, in the left pane click VPC
Network -> VPC Network Peering and in the right pane, copy the
value for Peered Project ID and paste it into this field.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve21.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Verify the Routing Mode is set to Global and click Submit.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve22.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>After about 5 minutes, the Region Status should show Connected.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve23.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Navigate back to VPC Network -> VPC Networks -> and click on the
provider-mgmt-network.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve24.png alt="Graphical user interface, table Description automatically
generated"></p>
</blockquote>
<ul>
<li>Click on the VPC NETWORK PEERING tab and click into the
servicenetworking name.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve25.png alt="Graphical user interface, text, website Description automatically
generated"></p>
</blockquote>
<ul>
<li>Click on EDIT.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve26.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Under Exchange Custom Routes, check the boxes for Import Custom
Routes and Export Custom Routes and click SAVE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve27.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>After saving, the route Status should all change to a Status of
accepted.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve27.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>On the GCVE browser tab, click Network in the left pane and then in
the right pane click the REGIONAL SETTINGS tab and click Add Region.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve28.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>On the Add Region screen, select the Region the SDDC is in, enable
Internet Access and Public IP Service, and use the next provider
CIDR block for the Edge Services CIDR and click Submit. After a few
minutes, it should show that the status is Operational and Enabled.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve29.png alt="Graphical user interface, application Description automatically
generated"></p>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve30.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<h3 id=setup-the-tenant-projects>
Setup the Tenant Projects
<a class=anchor href=#setup-the-tenant-projects>#</a>
</h3>
<p>The following steps describes the steps required to configure the tenant
projects. Many of the steps are the same done in the provider tenant in
creating a tenant service network and peering projects.</p>
<ul>
<li>In the Google Cloud Portal, click the project name dropdown beside
Google Cloud Platform.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve31.png alt="Graphical user interface, application, website Description
automatically
generated"></p>
</blockquote>
<ul>
<li>On the Select a project screen, click the ALL tab and select the
tenant project.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve32.png alt="Graphical user interface, text, application, Teams Description
automatically
generated"></p>
</blockquote>
<ul>
<li>In the top left pane click the three horizontal bars and navigate to
VPC Network -> VPC Networks -> and click the Default network name.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve33.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Click DELETE VPC NETWORK.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve34.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Click DELETE when prompted to confirm</p>
</li>
<li>
<p>Click CREATE VPC NETWORK.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve35.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following:</p>
<ul>
<li>
<p>Name: Name for the network such as &ldquo;tenantname-transit&rdquo;</p>
</li>
<li>
<p>New Subnet Name: Name to match the region such as
asia-southeast1</p>
</li>
<li>
<p>Region: The region the SDDC is in</p>
</li>
<li>
<p>IP Address Range: A CIDR range out of the next available range.
Check the box for &ldquo;I confirm the subnet configuration includes a
range outside the RFC 1918 address space&rdquo;</p>
</li>
<li>
<p>Private Google Access: Turn On</p>
</li>
<li>
<p>Click Done on the Subnet Section</p>
</li>
<li>
<p>Dynamic Routing Mode: Global</p>
</li>
<li>
<p>MTU: 1500</p>
</li>
<li>
<p>Click CREATE</p>
</li>
</ul>
</li>
<li>
<p>Once the network creation has completed, click into the network
name.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve36.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Click the PRIVATE SERVICE CONNECTION tab and then click ENABLE API.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve37.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Once completed, click ALLOCATE IP RANGE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve38.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Set the following:</p>
<ul>
<li>
<p>Name: service-network</p>
</li>
<li>
<p>IP Range Custom: Next available CIDR range</p>
</li>
<li>
<p>Click Allocate</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve39.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Click the PRIVATE CONNECTIONS TO SERVICES tab and then click CREATE
CONNECTION.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve40.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>On the private connection screen, ensure Google Cloud Platform is
selected and for Assigned Allocation, select the service-network
that was just created and click CONNECT.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve41.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>In the left pane click on VPC Network Peering and in the right pane
click into the servicenetworking name.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve42.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Click EDIT.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve43.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Under Exchange Custom Routes, check the boxes for Import Custom
Routes and Export Custom Routes and click SAVE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve44.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Navigate to the GCVE page and in the left pane click Network and in
the right pane click Add Private Connection.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve45.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following information:</p>
<ul>
<li>
<p>Service: VPC Network</p>
</li>
<li>
<p>Region: Region the SDDC is in</p>
</li>
<li>
<p>Peer Project ID: this will be the provider project name, which
can be found in the browser tab with the provider project by
clicking Google Cloud Platform and then copying the Project Name
field and pasting it into the Peer Project ID field</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve46.png alt="Graphical user interface, text, application, Word Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Peer Project Number: This is the project ID, which can be found in
the tab where the Project Name filed is immediately under that; copy
and paste the value into the Peer Project Number field</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve47.png alt="Graphical user interface, application, Word Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Peer VPC ID: This will be &ldquo;tenantname-transit&rdquo; unless it was named
differently. If it was name differently, enter the name used.</p>
</li>
<li>
<p>Tenant Project ID: To get the tenant project ID value, on the
browser tab with the provider project, in the left pane click VPC
Network -> VPC Network Peering and in the right pane, copy the
value for Peered Project ID and paste it into this field.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve48.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Verify the Routing Mode is set to Global and click Submit.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve49.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>After about 5 minutes the Region status should show Connected.</p>
</li>
<li>
<p>Repeat the previous steps for configure each tenant project.</p>
</li>
</ul>
<h3 id=create-a-jumphost-in-the-provider-project-and-allow-network-access>
Create a Jumphost in the Provider Project and Allow Network Access
<a class=anchor href=#create-a-jumphost-in-the-provider-project-and-allow-network-access>#</a>
</h3>
<p>The following section describes the steps required to create a jumphost
in the provider project to use for vCenter and NSX access as well as
other potential tasks made easier with local access.</p>
<ul>
<li>In a browser navigate to the provider project as previously
described and in the top right pane click the three horizontal bars
and select Compute Engine -> VM Instances.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve139.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Click CREATE INSTANCE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve51.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following information:</p>
<ul>
<li>
<p>Name: A name for the VM to help the region and function</p>
</li>
<li>
<p>Region: Same region as the SDDC</p>
</li>
<li>
<p>Zone: Zone in the region of the SDDC</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve52.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Scroll down to the Boot Disk section and click CHANGE</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve53.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Change the following:</p>
<ul>
<li>
<p>Operating System: Windows Server</p>
</li>
<li>
<p>Version: Select a current version, such as 2019 Datacenter</p>
</li>
<li>
<p>Size: Change the default size if desired</p>
</li>
<li>
<p>Click SELECT</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve54.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Scroll down and expand NETWORKING, DISKS, SECURITY, MANGEMENT,
SOLE-TENANCY</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve55.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Under &ldquo;Edit network interface&rdquo;, click the Network drop down and
select the provider-mgmt-network that was previously created and
then click DONE&lt; then click CREATE</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve56.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>After several minutes the jumphost should show ready; click on the
name of it to open the settings.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve57.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Click SET WINDOWS PASSWORD</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve58.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>On the pop-up screen, it will fill in the Username of the person
logged in, click SET to set the password.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve59.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>After a few moments it will display the password that is set. Copy
the password and then click CLOSE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve60.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Allow access through the firewall by clicking the three horizontal
bars in the top left and select VPC Network -> Firewall.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve61.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Click CREATE FIREWALL RULE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve62.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Set the following for the firewall rule:</p>
<ul>
<li>
<p>Name: Name stating the service provided such as &ldquo;rdp-in&rdquo;</p>
</li>
<li>
<p>Network: The provider-mgmt-network that was created previously</p>
</li>
<li>
<p>Direction of Traffic: Ingress</p>
</li>
<li>
<p>Targets: All instances in the network</p>
</li>
<li>
<p>Source IPv4 ranges: 0.0.0.0/0</p>
</li>
<li>
<p>Protocols and ports: TCP 3389</p>
</li>
<li>
<p>Click CREATE</p>
</li>
</ul>
</li>
<li>
<p>Click CREATE FIREWALL RULE again</p>
</li>
<li>
<p>Set the following for the firewall rule:</p>
<ul>
<li>
<p>Name: This will be for east-west connectivity, so name it to
identify what it is such as &ldquo;ew&rdquo; or &ldquo;east-west&rdquo;</p>
</li>
<li>
<p>Network: The provider-mgmt-network that was created previously</p>
</li>
<li>
<p>Direction of Traffic: Egress</p>
</li>
<li>
<p>Targets: All instances in the network</p>
</li>
<li>
<p>Source IPv4 ranges: The range of the management network, such as
100.64.0.0/16</p>
</li>
<li>
<p>Protocols and ports: Allow all</p>
</li>
<li>
<p>Click CREATE</p>
</li>
</ul>
</li>
<li>
<p>On the settings of the jumphost that was created, copy the External
IP to use in RDP.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve63.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Log into the jumphost with the external IP and the credentials
previously created to verify access.</li>
</ul>
<h2 id=prepare-for-and-deploy-the-reverse-proxy>
Prepare for and Deploy the Reverse Proxy
<a class=anchor href=#prepare-for-and-deploy-the-reverse-proxy>#</a>
</h2>
<p>The following section describes the steps required to prepare the
environment for the proxy, generate it, and then deploy and associate
the proxy to the SDDC that was created.</p>
<h3 id=create-the-cds-instance-if-not-already-created>
Create the CDs Instance (If not already created)
<a class=anchor href=#create-the-cds-instance-if-not-already-created>#</a>
</h3>
<p>The following steps describes the steps required to create a CDs
instance if one does not already exist that the SDDC should be
associated to.</p>
<ul>
<li>In Partner Navigator, navigate to VMware Cloud Director service and
click CREATE INSTANCE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve64.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Enter the required information and click CREATE INSTANCE.</li>
</ul>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve65.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
<ul>
<li>The CDs instance will take around 30 minutes to complete.</li>
</ul>
<h3 id=generate-the-proxy>
Generate the Proxy
<a class=anchor href=#generate-the-proxy>#</a>
</h3>
<p>The following steps describes the steps required to generate the proxy
that will be used for the connection from CDs to the SDDC. These steps
are completed from the partner navigator portal and require the CDs
instance to already exist.</p>
<ul>
<li>
<p>On the GCP provider based jumphost, log into Partner Navigator,
navigate to VMware Cloud Director service.</p>
</li>
<li>
<p>On the CDs instance to associate the SDDC to click Actions and
select Generate VMware Reverse Proxy OVF.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve66.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following:</p>
<ul>
<li>
<p>API Token: API token from your account in Partner Navigator</p>
</li>
<li>
<p>Datacenter Name: Datacenter</p>
</li>
<li>
<p>vCenter FQDN: The FQDN of the VCSA appliance under Google Cloud
VMware Engine -> Resources -> VSHPERE MANAGEMENT NETWORK</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve67.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Management IP for vCenter: The IP address of the VCSA appliance</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve68.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>NSX URL: URL of the NSX manager</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve69.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Additional hosts within the SDDC to proxy: The IP address of the
ESXi hosts that are part of the SDDC. Note that each IP MUST be on a
separate line</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve70.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Once the information has been entered, click GENERATE VMWARE REVERSE
PROXY OVF</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve71.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>The Activity Log on the CDs instance can be monitored for the status
of the task. Skip ahead to Prepare the Environment for the Proxy if
desired to complete those steps while waiting for the proxy to
generate.</p>
</li>
<li>
<p>Once the task has completed, click the three horizontal dots, and
select View Files.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve72.png alt="Graphical user interface, text, application Description
automatically generated"></p>
</blockquote>
<ul>
<li>Click the down arrow icon to download the OVF file to the provider
jumphost locally.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve73.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<h3 id=prepare-the-environment-for-the-proxy>
Prepare the Environment for the Proxy
<a class=anchor href=#prepare-the-environment-for-the-proxy>#</a>
</h3>
<p>Before deploying the proxy, a network segment must be created and DHCP
setup so that it can get an IP address. The following steps describe how
to create the segment and configure DHCP.</p>
<ul>
<li>On the GCVE page in the Google Cloud Portal, click Resource in the
left pane and click the name of the SDDC.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve74.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Click on VSPHERE MANAGEMENT NETWORK tab and in the right click the
NSX Manager FQDN and copy the link location.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve75.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>RDP to the jumphost that was created on the provider network
previously, open a browser and navigate to the FQDN of the NSX
manager from the link that was copied.</p>
</li>
<li>
<p>Back on the GCVE browser, click the SUMMARY tab and then in the
NSX-T Login Info section, click View.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve76.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>In the Password section, click Copy.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve77.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Log into the NSX-T manager URL as admin with the password that was
coped.</p>
</li>
<li>
<p>In the NSX-T manager UI, click the Networking tab in the left pane
click DHCP.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve78.png alt="A screenshot of a phone Description automatically generated with
medium confidence"></p>
</blockquote>
<ul>
<li>Click ADD DHCP PROFILE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve79.png alt="Graphical user interface, text Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following:</p>
<ul>
<li>
<p>Profile Name: A name for the DHCP profile</p>
</li>
<li>
<p>Profile Type: DHCP Server</p>
</li>
<li>
<p>Server IP Address: A CIDR subnet for the scope</p>
</li>
<li>
<p>Edge Cluster: The edge cluster that was created</p>
</li>
<li>
<p>Click SAVE</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve80.png alt="A screenshot of a computer Description automatically
generated"></p>
</blockquote>
<ul>
<li>In the left pane click Tier-1 Gateways and in the right pane beside
Tier1, click the three vertical dots and select Edit.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve81.png alt="A screenshot of a computer Description automatically generated with
medium confidence"></p>
</blockquote>
<ul>
<li>Click Set DHCP Configuration.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve82.png alt="Graphical user interface Description automatically
generated"></p>
</blockquote>
<ul>
<li>For Type select DHCP Server and for DHCP Server Profile select the
DHCP Profile that was created and click SAVE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve83.png alt="Graphical user interface, text Description automatically
generated"></p>
</blockquote>
<ul>
<li>Click SAVE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve84.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>In the left pane click Segments, then click ADD SEGMENT.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve85.png alt="A screenshot of a computer Description automatically generated with
medium confidence"></p>
</blockquote>
<ul>
<li>
<p>Enter the following:</p>
<ul>
<li>
<p>Segment Name: Proxy</p>
</li>
<li>
<p>Connected Gateway: Tier1 | Tier1</p>
</li>
<li>
<p>Transport Zone: TZ-Overlay</p>
</li>
<li>
<p>Subnet: The subnet CIDR</p>
</li>
<li>
<p>Click EDIT DHCP CONFIG</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve86.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Check the DHCP Config enabled, set a DHCP range, enter the DNS
servers from GCVE, and then click APPLY (the DNS servers can be
found on the GCVE page, clicking Resources in the left tab and then
clicking the name of the SDDC, and on the SUMMARY tab under Private
Cloud DNS Servers.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve87.png alt="Graphical user interface, website Description automatically
generated"></p>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve88.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<h3 id=deploy-and-connect-the-proxy>
Deploy and Connect the Proxy
<a class=anchor href=#deploy-and-connect-the-proxy>#</a>
</h3>
<p>The following steps describes the steps required to deploy the proxy and
associate it to the CDs instance in Partner Navigator.</p>
<ul>
<li>
<p>On the GCP provider based jumphost, open a browser to the vCenter
UI.</p>
</li>
<li>
<p>Right click Cluster and select Deploy OVF Template.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve89.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Select Local File and navigate to the reverse proxy OVF that was
downloaded, select it and click NEXT.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve90.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Provide a virtual machine name and click NEXT.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve91.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Select the Cluster name and click NEXT.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve92.png alt="Graphical user interface, text, application, Teams Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Click Next.</p>
</li>
<li>
<p>Select the vsanDatastore and click NEXT.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve93.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Select the Proxy network that was previously created and click NEXT.</p>
</li>
<li>
<p>On the Customize Template page, copy and save the root password and
click NEXT.</p>
</li>
<li>
<p>Click FINISH to being the deployment.</p>
</li>
<li>
<p>After deployment, power on the appliance.</p>
</li>
<li>
<p>Log into the proxy appliance and verify it has an IP address by
running &ldquo;ip a&rdquo;.</p>
</li>
<li>
<p>Run the command &ldquo;systemctl status transporter-client.service&rdquo; and
ensure it shows running.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve94.png alt="Graphical user interface, text Description automatically
generated"></p>
</blockquote>
<ul>
<li>If the transporter-client.service is showing an error, verify that
DNS resolution is working properly and that it can access the
Internet. The below screenshot shows an error when DNS is not
working.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve95.png alt="Text Description automatically
generated"></p>
</blockquote>
<ul>
<li>Run the command &ldquo;transporter-status.sh&rdquo; and verify it shows
connected.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve96.png alt="A screenshot of a computer Description automatically generated with
medium confidence"></p>
</blockquote>
<ul>
<li>In Partner Navigator, go to the CDs instance the proxy was generated
from and click Actions -> Associate a Datacenter via VMware Proxy.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve97.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following:</p>
<ul>
<li>
<p>Datacenter name: Datacenter</p>
</li>
<li>
<p>vCenter FQDN: VCSA FQDN that was used to generate the proxy</p>
</li>
<li>
<p>NSX URL: URL of NSX manager that was used to generate the proxy</p>
</li>
<li>
<p>It will attempt an initial connection to the proxy and if it
connects, it will display Connection Established</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve98.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>On the Credentials page, enter the following:</p>
<ul>
<li>
<p>vCenter Username: <a href=mailto:cloudowner@gve.local>cloudowner@gve.local</a></p>
</li>
<li>
<p>vCenter Password: The password for the supplied username</p>
</li>
<li>
<p>Disconnected Network Segment: Enter the name of the network the
proxy is on (Proxy)</p>
</li>
<li>
<p>Authentication to NSX Type: Authenticate via NSX Username and
Password</p>
</li>
<li>
<p>NSX Username: admin</p>
</li>
<li>
<p>NSX Password: The password for NSX admin account</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve99.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Check the box to acknowledge charges will begin and click SUBMIT.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve100.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>The Activity Log on the CDs instance can be monitored for the status
of the association task.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve101.png alt="Graphical user interface, application Description automatically
generated with medium
confidence"></p>
</blockquote>
<ul>
<li>
<p>It should take about 5 to 10 minutes for the task to completed.</p>
</li>
<li>
<p>Once the task has finished, it can take up to 4 hours to show up as
an associated SDDC in the CDs instance. Opening the VCD instance to
bring up the UI should show the SDDC as a PVCD that can be used to
create VDCs for tenants; you do not have to wait for it to show up
as associated in the Partner Navigator portal.</p>
</li>
</ul>
<h2 id=deploy-and-configure-ipsec-tunnel>
Deploy and Configure IPsec Tunnel
<a class=anchor href=#deploy-and-configure-ipsec-tunnel>#</a>
</h2>
<p>The following section describes the steps required to deploy and
configure a StrongSwan VPN appliance in the tenant&rsquo;s project to connect
to their T1 in the SDDC that was deployed via an IPsec tunnel. This is
merely a demonstration of how to deploy a VPN appliance and any suitable
appliance can be used.</p>
<p>The steps below are based on CentOS 7 as the operating system; using
another flavor of Linux may result in different steps or actions
required to get it to work properly.</p>
<p>The default routes to the Internet will use instance tags to keep from
the routes leaking back into the GCVE environment. This tag can be
whatever the provider desires, but it must be uniform across all routes
that point to the Internet and be applied to any VM that will need to be
access to/from to the Internet in the provider owned customer project.</p>
<h3 id=deploy-a-linux-instance-and-configure-strongswan>
Deploy a Linux Instance and Configure StrongSwan
<a class=anchor href=#deploy-a-linux-instance-and-configure-strongswan>#</a>
</h3>
<p>The following steps describes the steps required to deploy a virtual
machine, install StrongSwan and configure it for an IPSec tunnel
connection to a tenant T1.</p>
<ul>
<li>First create a firewall rule in the tenant project by going to VPC
Network -> Firewall and click CREATE FIREWALL RULE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve102.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following:</p>
<ul>
<li>
<p>Name: gcve-transit</p>
</li>
<li>
<p>Network: tenatname-transit</p>
</li>
<li>
<p>Priority: 100</p>
</li>
<li>
<p>Direction of Traffic: Ingress</p>
</li>
<li>
<p>Action on match: Allow</p>
</li>
<li>
<p>Targets: All instances in the network</p>
</li>
<li>
<p>Source IPv4 Ranges: Range for transit network &ndash; such as
100.64.0.0/16</p>
</li>
<li>
<p>Protocols and ports: Allow all</p>
</li>
<li>
<p>Click Save</p>
</li>
</ul>
</li>
<li>
<p>Click CREATE FIREWALL RULE again and enter the following:</p>
<ul>
<li>
<p>Name: ipsec-egress</p>
</li>
<li>
<p>Network: tenatname-transit</p>
</li>
<li>
<p>Priority: 100</p>
</li>
<li>
<p>Direction of Traffic: Egress</p>
</li>
<li>
<p>Action on match: Allow</p>
</li>
<li>
<p>Targets: All instances in the network</p>
</li>
<li>
<p>Destination IPv4 Ranges: Range for transit network &ndash; such as
100.64.0.0/16</p>
</li>
<li>
<p>Protocols and ports: IPsec Ports</p>
</li>
<li>
<p>Click Save</p>
</li>
</ul>
</li>
<li>
<p>Create a new instance in the tenant and set:</p>
<ul>
<li>
<p>Boot Disk: Change to CentOS 7</p>
</li>
<li>
<p>Expand NETWORKING, DISKS, SECRUITY, MANGEMENT, SOLE-TENANCY</p>
<ul>
<li>
<p>IP Forwarding: Check the box to Enable</p>
</li>
<li>
<p>Ensure the network interface is on the &ldquo;tenantname-transit&rdquo;
network</p>
</li>
<li>
<p>Click CREATE</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Once completed, click on the name of the instance to bring up its
settings.</p>
<ul>
<li><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve103.png alt="Graphical user interface, text Description automatically
generated with medium
confidence"></li>
</ul>
</li>
<li>
<p>At the top of the screen, click EDIT.</p>
<ul>
<li><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve104.png alt="Graphical user interface, application Description
automatically
generated"></li>
</ul>
</li>
<li>
<p>Scroll down and in the Network Tags box, put the network tag name,
then save the settings.</p>
<ul>
<li><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve105.png alt="Graphical user interface, text, application Description
automatically
generated"></li>
</ul>
</li>
<li>
<p>Under the Connect column click SSH to connect to it.</p>
</li>
<li>
<p>Run sudo su and then run &ldquo;yum install strongswan -y&rdquo; to install
strongswan.</p>
</li>
<li>
<p>Copy the command below and paste into the shell with ctrl v</p>
</li>
</ul>
<blockquote>
<p>cat >> /etc/sysctl.conf &lt;&lt; EOF</p>
<p>net.ipv4.ip_forward = 1</p>
<p>net.ipv4.conf.all.accept_redirects = 0</p>
<p>net.ipv4.conf.all.send_redirects = 0</p>
<p>EOF</p>
</blockquote>
<ul>
<li>
<p>Run the command sysctl -p</p>
</li>
<li>
<p>CD to /etc/strongswan/swanctl/conf.d and run vi nsxt.conf.</p>
<ul>
<li>Enter the following information in the nsxt.conf file replacing
localAddr with the local IP of the tunnel, remoteAddr with the
remote IP of the tunnel, remoteTS with the network CIDR of the
remote end of the tunnel, and PresharedKey with the secret used
for the tunnel.</li>
</ul>
</li>
</ul>
<blockquote>
<p>connections {</p>
<p>gw-gw {</p>
<p>local_addrs = localAddr</p>
<p>remote_addrs = remoteAddr</p>
<p>local {</p>
<p>auth = psk</p>
<p>id = localAddr</p>
<p>}</p>
<p>remote {</p>
<p>auth = psk</p>
<p>id = remoteAddr</p>
<p>}</p>
<p>children {</p>
<p>net-net {</p>
<p>local_ts = 0.0.0.0/0</p>
<p>remote_ts = remoteTS</p>
<p>start_action = start</p>
<p>updown = /usr/local/libexec/ipsec/_updown iptables</p>
<p>esp_proposals = aes128gcm128-modp2048</p>
<p>}</p>
<p>}</p>
<p>version = 2</p>
<p>proposals = aes128-sha256-modp2048</p>
<p>}</p>
<p>}</p>
<p>secrets {</p>
<p>ike-1 {</p>
<p>id-1 = localAddr</p>
<p>secret = PresharedKey</p>
<p>}</p>
<p>ike-2 {</p>
<p>id-2 = remoteAddr</p>
<p>secret = PresharedKey</p>
<p>}</p>
<p>ike-3 {</p>
<p>id-3a = localAddr</p>
<p>id-3b = remoteAddr</p>
<p>secret = PresharedKey</p>
<p>}</p>
<p>ike-4 {</p>
<p>secret = PresharedKey</p>
<p>}</p>
<p>ike-5 {</p>
<p>id-5 = localAddr</p>
<p>secret = PresharedKey</p>
<p>}</p>
<p>}</p>
</blockquote>
<ul>
<li>
<p>Run the command swanctl --load-all</p>
</li>
<li>
<p>CD to /etc and run &ldquo;vi ipsec.secrets&rdquo;</p>
<ul>
<li>Enter the following line, replacing the words with their values:
localTunnelIP remoteTunnelIP : PSK &lsquo;PresharedKey" and save the
file.</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve106.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Run the command sudo strongswan restart</p>
</li>
<li>
<p>Run the command yum install iptables-services and once installed run
systemctl start iptables</p>
</li>
<li>
<p>Add the following iptables rules in to allow traffic to be
forwarded. Any line that contains remoteNet should have that
replaced with the CIDR of the remote network in GCVE. Note that each
line must be copied and pasted into the SSH session on the VPN
server one by one.</p>
</li>
</ul>
<blockquote>
<p>iptables -A INPUT -i eth0 -p esp -j ACCEPT</p>
<p>iptables -A INPUT -i eth0 -p ah -j ACCEPT</p>
<p>iptables -A INPUT -i eth0 -p udp -m udp --sport 500 --dport 500 -j
ACCEPT</p>
<p>iptables -A INPUT -i eth0 -p udp -m udp --sport 4500 --dport 4500 -j
ACCEPT</p>
<p>iptables -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT</p>
<p>iptables -A FORWARD -s remoteNet -d 0.0.0.0/0 -i eth0 -m policy --dir
in --pol ipsec --reqid 1 --proto esp -j ACCEPT</p>
<p>iptables -A FORWARD -s 0.0.0.0/0 -d remoteNet -o eth0 -m policy --dir
out --pol ipsec --reqid 1 --proto esp -j ACCEPT</p>
<p>iptables -A OUTPUT -o eth0 -p esp -j ACCEPT</p>
<p>iptables -A OUTPUT -o eth0 -p ah -j ACCEPT</p>
<p>iptables -A OUTPUT -o eth0 -p udp -m udp --sport 500 --dport 500 -j
ACCEPT</p>
<p>iptables -A OUTPUT -o eth0 -p udp -m udp --sport 4500 --dport 4500
-j ACCEPT</p>
<p>iptables -A OUTPUT -p tcp -m tcp --sport 22 -j ACCEPT</p>
<p>iptables -A FORWARD -s 0.0.0.0/0 -d remoteNet -i eth0 -m policy --dir
in --pol ipsec --reqid 1 --proto esp -j ACCEPT</p>
<p>iptables -A FORWARD -s remoteNet -d 0.0.0.0/0 -o eth0 -m policy --dir
out --pol ipsec --reqid 1 --proto esp -j ACCEPT</p>
</blockquote>
<ul>
<li>Delete the two listed REJECT rules by running &ldquo;iptables -D
SECTION_NAME position#&rdquo;. For example, in the screen shot below, the
REJECT under INPUT is the 5^th^ rule down, so the command to delete
it is &ldquo;iptables -D INPUT 5&rdquo;. Notice after running the command the
REJECT rule under INPUT is no longer present.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve107.png alt="A picture containing text Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>To delete the REJECT under FORWARD, run &ldquo;iptables -D FORWARD 1&rdquo; as
it is in position 1.</p>
</li>
<li>
<p>Run the command service iptables save</p>
</li>
<li>
<p>Run systemctl restart iptables</p>
</li>
<li>
<p>In the GCP console in the tenant project navigate to VPC Network ->
Routes and click CREATE ROUTE.</p>
</li>
<li>
<p>Enter the following:</p>
<ul>
<li>
<p>Name: tenantname-networkcidr</p>
</li>
<li>
<p>Network: tenantname-transit</p>
</li>
<li>
<p>Destination Range: IP CIDR range in the SDDC for the tenant</p>
</li>
<li>
<p>Priority: 100</p>
</li>
<li>
<p>Next Hop: Specify an instance</p>
</li>
<li>
<p>Next Hop Instance: The StrongSwan VM.</p>
</li>
<li>
<p>Click CREATE</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve108.png alt="Graphical user interface, application Description automatically
generated with medium
confidence"></p>
</blockquote>
<h3 id=configure-ipsec-vpn-in-nsx-and-configure-tenant-firewall-rules>
Configure IPSec VPN in NSX and Configure Tenant Firewall Rules
<a class=anchor href=#configure-ipsec-vpn-in-nsx-and-configure-tenant-firewall-rules>#</a>
</h3>
<p>The following steps describes the steps required to create a CDs
instance if one does not already exist that the SDDC should be
associated to.</p>
<ul>
<li>
<p>Log into Partner Navigator and navigate to Cloud Director Service
and open the instance that is managing the GCVE SDDC.</p>
</li>
<li>
<p>In the left pane click Edge Gateways and in the right pane click on
the name of the tenant&rsquo;s edge.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve109.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Click on IPSec VPN and then click NEW.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve110.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following:</p>
<ul>
<li>
<p>General Settings:</p>
<ul>
<li>
<p>Name: Name the IPSec tunnel such as tenantname-gcve-ipsec</p>
</li>
<li>
<p>Click NEXT</p>
</li>
</ul>
</li>
<li>
<p>Peer Authentication Mode:</p>
<ul>
<li>
<p>Authentication Mode: Pre-Shared Key</p>
</li>
<li>
<p>Pre-Shared Key: Enter the PSK used for the tunnel</p>
</li>
<li>
<p>Click NEXT</p>
</li>
</ul>
</li>
<li>
<p>Endpoint Configuration:</p>
<ul>
<li>
<p>Local Endpoint:</p>
<pre><code>- IP Address: Local IP address of the tunnel (edge
      external network address)

- Networks: Local network CIDR(s) for the tunnel
</code></pre>
</li>
<li>
<p>Remote Endpoint:</p>
<pre><code>- IP Address: Remote IP address of the VPN appliance

- Networks: 0.0.0.0/0
</code></pre>
<ul>
<li>Remote ID: Remote IP address of the VPN appliance</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve111.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Click NEXT, then click FINISH to save the IPSec tunnel
configuration.</p>
</li>
<li>
<p>Click on VIEW STATISTICS.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve112.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>After a few moments, the tunnel should show the Tunnel Status and
IKE Service Status as Up.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve113.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Log into the GCP provider jump host, navigate the NSX URL and log in
as admin.</p>
</li>
<li>
<p>Click the Security tab, then in the left pane select Gateway
Firewall, and in the right pane click the Gateway dropdown and
select the tenant&rsquo;s T1 to add the firewall rule to.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve114.png alt="A screenshot of a computer Description automatically generated with
medium confidence"></p>
</blockquote>
<ul>
<li>Click ADD POLICY.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve115.png alt="A screenshot of a computer Description automatically generated with
medium confidence"></p>
</blockquote>
<ul>
<li>Click in the Name box for the policy and provide a name such as
&ldquo;TenantName Tenant Rules&rdquo;.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve116.png alt="A screenshot of a computer Description automatically generated with
medium confidence"></p>
</blockquote>
<ul>
<li>Click the three horizontal dots to the left of the policy name and
select Add Rule.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve117.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following:</p>
<ul>
<li>
<p>Sources: Add the remote GCP tenant project&rsquo;s CIDR block</p>
</li>
<li>
<p>Destination: Select Any for any local network or alternatively
it can be locked down to a single CIDR</p>
</li>
<li>
<p>Services: Any (or filter to specifics if desired)</p>
</li>
<li>
<p>Action: Allow</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve118.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Add another rule called Allow Outbound and set the following:</p>
<ul>
<li>
<p>Sources: Select Any for any local network or alternatively it
can be locked down to a single CIDR</p>
</li>
<li>
<p>Destination: Add the remote GCP tenant project&rsquo;s CIDR block</p>
</li>
<li>
<p>Action Allow</p>
</li>
<li>
<p>Once ready, click PUBLISH.</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve119.png alt="A screenshot of a computer Description automatically generated with
medium confidence"></p>
</blockquote>
<ul>
<li>Test the tunnel connectivity by deploying an instance in the GCP
tenant project that was configured for the tunnel and the tenant in
the SDDC to confirm it is functioning. Here we see that SSH/HTTP is
connected between both tenant workloads.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve120.png alt="Text Description automatically
generated"></p>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve121.png alt="Text Description automatically
generated"></p>
</blockquote>
<h2 id=peer-existing-customer-vpc>
Peer Existing Customer VPC
<a class=anchor href=#peer-existing-customer-vpc>#</a>
</h2>
<p>The following section describes the steps required to pair a tenant
owned customer VPC to an existing customer VPC. This step is optional as
a customer may not have an existing GCP project.</p>
<p>The steps below will require information from the customer and given to
the customer to complete the peering process.</p>
<h3 id=configure-provider-owned-customer-vpc-for-peering>
Configure Provider Owned Customer VPC for Peering
<a class=anchor href=#configure-provider-owned-customer-vpc-for-peering>#</a>
</h3>
<p>The following steps describes the steps required to peer the provider
owned customer VPC to an existing customer owned VPC to enable
connectivity between them.</p>
<ul>
<li>In the GCP console, switch to the tenant to configure project and go
to VPC Network -> VPC Network Peering.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve122.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>Click CREATE PEERING CONNECTION.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve123.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Click CONTINUE.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve124.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Enter the following:</p>
<ul>
<li>
<p>Name: name the VPC connection something obvious such as
&ldquo;tenantname-to-gpc-vpc&rdquo;</p>
</li>
<li>
<p>Your VPC Network: Select the tenant&rsquo;s transit network</p>
</li>
<li>
<p>Peered VPC Network: In another project</p>
</li>
<li>
<p>Project ID: The name of the customer owned project</p>
</li>
<li>
<p>VPC Network Name: The default network name in the customer&rsquo;s
project</p>
</li>
<li>
<p>Exchange Custom Routes: Ensure both Import and Export custom
routes are checked</p>
</li>
<li>
<p>Exchange Subnet Routes with Public IP: Select Export subnet
routes with public IP</p>
</li>
<li>
<p>Click CREATE</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve125.png alt="Graphical user interface, text, application, email Description
automatically
generated"></p>
</blockquote>
<ul>
<li>The status of the peering will show with a Status of Inactive until
the peering process is completed on the customer VPC side.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve126.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<h3 id=customer-to-configure-the-customer-owned-vpc-for-peering>
Customer to Configure the Customer Owned VPC for Peering
<a class=anchor href=#customer-to-configure-the-customer-owned-vpc-for-peering>#</a>
</h3>
<p>The following steps describes the steps required to peer the customer
owned VPC to the provider owned customer VPC to enable connectivity
between them.</p>
<ul>
<li>
<p>Complete the same process as shown in the previous step and provide
the customer the following information to complete the peering:</p>
<ul>
<li>
<p>Peered VPC Network: In another project</p>
</li>
<li>
<p>Project ID: The name of the provider owned customer project</p>
</li>
<li>
<p>VPC Network Name: The default network name in the tenant owned
customer&rsquo;s project &ldquo;tenantname-transit&rdquo;</p>
</li>
<li>
<p>Exchange Custom Routes: Ensure both Import and Export custom
routes are checked</p>
</li>
<li>
<p>Exchange Subnet Routes with Public IP: Select Export subnet
routes with public IP</p>
</li>
<li>
<p>Click CREATE</p>
</li>
</ul>
</li>
<li>
<p>Once the customer has completed the peering process, click REFRESH
on the VPC network peering page and the Status should change to
Active.</p>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve127.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>Click on Routes on the VPC Network page, then click on the PEERING
tab and it should display a list of peering routes discovered
through the peering process.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve128.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>To test the connectivity, try to SSH/ping from a workload on the
customers GCVE environment into a workload in the GCP peering VPC. A
firewall rule will need to be in place on the customer&rsquo;s VPC side
allowing the connectivity if it is not already present.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve129.png alt="Text Description automatically
generated"></p>
</blockquote>
<h2 id=setup-nat-vms-for-internet-access-optional>
Setup NAT VMs for Internet Access (Optional)
<a class=anchor href=#setup-nat-vms-for-internet-access-optional>#</a>
</h2>
<p>Note that this section is optional and only required if the customer
will have Internet traffic egressing from the provider owned customer
project.</p>
<p>The following section describes the steps required to setup a group of
VMs for NAT for Internet access for workloads within GCVE.</p>
<p>These steps are required if the Internet access is egressing from the
provider owned customer project or if a customer is routing all traffic
to their peered project. The NAT VMs should be created and configured in
the project that Internet access is egressing from.</p>
<h3 id=prepare-and-deploy-nat-vms>
Prepare and Deploy NAT VMs
<a class=anchor href=#prepare-and-deploy-nat-vms>#</a>
</h3>
<p>The following steps describes the steps required to prepare the
environment to deploy the VMs used for NAT for Internet access and
should be run from the project where the traffic will egress using NAT&rsquo;s
and ILB&rsquo;s based on GCP compute instances.</p>
<p>Another third party solution can be used for this part which is
encouraged for more flexible configuration and easier day two
operations.</p>
<p>Two NAT VMs will be deployed, one in a different AZ in the region for
redundancy in an active/passive configuration. The machine size for the
NAT VMs below is small for testing purposes, these should be sized
appropriately based on the expected throughput.</p>
<p>The shell commands are embedded in the attached text document here.
![Graphical user interface, application Description automatically</p>
<blockquote>
<p>generated](/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve130.emf)</p>
</blockquote>
<ul>
<li>In the project where the Internet traffic will egress, in the top
blue bar, click the Cloud Shell icon to launch the shell.</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve131.png alt="Graphical user interface, application Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Prior to copying the shell commands, do a find and replace and
replace the following entries. <strong>Note</strong>: Be careful not to insert
any extra spaces or carriage returns to avoid syntax errors.</p>
<ul>
<li>
<p>Find: gcve-team-project ; Replace with: tenant-project-name (ex:
tenant1-project)</p>
</li>
<li>
<p>Find: --subnet=cds-tenant01-us-west2 ; Replace with:
--subnet=tenant-transit-subnet (ex: asia-southeast1)</p>
</li>
<li>
<p>Find: cds-tenant01 ; Replace with: tenant-transit-network (ex:
tenant1-transit)</p>
</li>
<li>
<p>Find: -region=us-west2 ; Replace with:
-region=project-region-name (ex: asia-southeast1)</p>
</li>
<li>
<p>Find: --zone=us-west2-a ; Replace with:
--zone=project-region-az-a (ex: asia-southeast1-a)</p>
</li>
<li>
<p>Find: --zone=us-west2-b ; Replace with:
--zone=project-region-az-b (ex: asia-southeast1-b)</p>
</li>
<li>
<p>Find: cds-natgw-startupscripts/nat_gateway_startup.sh ; Replace
with: tenant-bucket-name/name_of_startup_script.sh (ex:
tenant1-storage/nat_gateway_startup.sh)</p>
</li>
<li>
<p>Find: us-west2 ; Replace with: project-region-name (ex:
asia-southeast1)</p>
</li>
<li>
<p>Fine: n1-standard-2 ; Replace with: name of properly sized
instance type requried</p>
</li>
</ul>
</li>
<li>
<p>If there are known instances with private Ips that need public
Internet routing, run the command below to allocate public IP(s) to
add to the NAT startup script prior to uploading. This would need to
be done for each instance that needs incoming Internet traffic.</p>
<ul>
<li>
<p>gcloud compute addresses create
natgw-asia-southeast1-forwarding-external-01 --region
asia-southeast1</p>
<ul>
<li>Change the region to match where the project is located</li>
</ul>
</li>
<li>
<p>Run the following command to display the IP that was allocated:</p>
<ul>
<li>gcloud compute addresses describe
natgw-asia-southeast1-forwarding-external-01 --region
asia-southeast1</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve132.png alt="Text Description automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Note this IP address to use in the startup script section below.</p>
</li>
<li>
<p>Create a storage bucket and save the startup script:</p>
<ul>
<li>
<p>Under the Google Cloud Platform menu, click Cloud Storage.</p>
<ul>
<li><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve133.png alt="Graphical user interface, application Description
automatically
generated"></li>
</ul>
</li>
<li>
<p>Click CREATE BUCKET.</p>
<ul>
<li><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve134.png alt="Graphical user interface Description automatically
generated with medium
confidence"></li>
</ul>
</li>
<li>
<p>Enter a name for the bucket such as &ldquo;tenantname-storage&rdquo; and
click CREATE.</p>
</li>
<li>
<p>Open the below attached text file.Replace the text line
&ldquo;iptables -t nat -A PREROUTING -d $nlb_vip -i ens4 -j DNAT
--to $test_endpoint_ip " for $nbl_vip with the public IP
allocated for the workload requiring incoming Internet
connections and $test_endpoint_ip with the private IP of the
workload servicing the traffic (web server, etc).
<img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve135.emf alt="Graphical user interface"></p>
</li>
<li>
<p>If there as a public IP address allocated for a device that
needs incoming Internet traffic, replace the line below with the
public IP that was allocated and the correct private IP. Also
delete the other line if it is not required; this iptables
command would be a line for each public IP that will be
forwarded. Change the public IP after -d to what was previously
allocated and the IP after DNAT to the private IP of the host
(not the T1 gateway, the private IP of the device, such as the
Windows server)</p>
<ul>
<li>iptables -t nat -A PREROUTING -d 35.236.94.128 -i ens4 -j
DNAT --to 10.0.0.3</li>
</ul>
</li>
<li>
<p>Save the file locally as &ldquo;nat_gateway_startup.sh&rdquo; or something
similar and close it.</p>
</li>
<li>
<p>Back in the storage bucket that was created, click into the
bucket name, and then click UPLOAD FILES.</p>
</li>
<li>
<p>Upload the nat_gateway_startup.sh file that was saved locally.</p>
</li>
</ul>
</li>
<li>
<p>From the text file with the shell commands, copy and paste the
contents to create and configure the NAT and ILB:</p>
<ul>
<li>
<p>Open the GCP cloud shell</p>
</li>
<li>
<p>Copy and paste first line into Google cloud shell to create the
SSH firewall rule.</p>
</li>
<li>
<p>Skip the two lines that being with &ldquo;glcoud compute networks&rdquo; as
they should already be created.</p>
</li>
<li>
<p>Copy the two lines with &ldquo;gcloud compute addresses create&rdquo; and
paste those into the shell and hit enter to create the
addresses.</p>
</li>
<li>
<p>Copy the next two lines with &ldquo;nat_#_ip=$&rdquo; and paste those
into the shell and hit enter to set the NAT IP variables.</p>
</li>
<li>
<p>Copy the block commands with &ldquo;gcloud compute instance-templates&rdquo;
and paste those into the shell and hit enter the create the
templates.</p>
</li>
<li>
<p>Copy the lines &ldquo;gcloud compute health-checks create&rdquo; down
through the three lines with &ldquo;glcoud compute firewall-rules
create&rdquo; and paste them into the shell and hit enter to create
the health check and firewall rules.</p>
</li>
<li>
<p>Copy the lines &ldquo;gcloud compute instance-groups managed create&rdquo;
and paste them into the shell and hit enter to create the
instances.</p>
</li>
<li>
<p>Copy the line &ldquo;gcloud compute health-checks create&rdquo; and paste it
into the shell and hit enter to create the next health check.</p>
</li>
<li>
<p>Copy the line &ldquo;gcloud compute backend-services create&rdquo; and paste
it into the shell and hit enter to create the natgw backend.</p>
</li>
<li>
<p>Copy the two lines &ldquo;gcloud compute backend-services add-backend&rdquo;
and paste them into the shell and hit enter to add the two nats
to the backend that was just created.\</p>
</li>
<li>
<p>The lines under Just Outbound NAT can be skipped if the customer
has both incoming and outgoing traffic.</p>
</li>
<li>
<p>Copy the line &ldquo;gcloud compute forwarding-rules create&rdquo; and paste
it into the shell and hit enter to create the forwarding rule.</p>
</li>
<li>
<p>Copy the lines for &ldquo;gcloud compute routes create&rdquo; and paste them
into the shell and hit enter to create the two routes.</p>
</li>
<li>
<p>Under Public IP Exposure settings, copy the line &ldquo;gcloud compute
backend-services create&rdquo; and paste it into the shell and hit
enter to create the backend service for the ILB.</p>
</li>
<li>
<p>Copy the two lines with &ldquo;gcloud compute backend-services
add-backend&rdquo; and paste them into the shell and hit enter to add
the hosts to the backend.</p>
</li>
<li>
<p>If a public IP was allocated previously for an existing
workload, copy the last line with &ldquo;gcloud beta compute
forwarding-rules&rdquo; and paste it into the shell and hit enter to
add the forwarding rule.</p>
</li>
<li>
<p><strong>Note</strong>: When adding a new public IP for a workload, the last
two lines in this file would need to be reran to allocate the
public IP, then create a forwarding rule for it.</p>
</li>
</ul>
</li>
</ul>
<h3 id=configure-firewall-and-routes>
Configure Firewall and Routes
<a class=anchor href=#configure-firewall-and-routes>#</a>
</h3>
<p>The following steps describes the steps required create the firewall
rule and routes required to load balancer Internet traffic across the 3
NAT internet gateways that were previously deployed.</p>
<p>The default routes for the NAT will use instance tags to keep from the
routes leaking back into the GCVE environment. This tag can be whatever
the provider desires, but it must be uniform across all 3 routes that
will direct traffic to the Internet via the NAT gateways. This applies
to the routes created below for nat1, nat2, and nat3. This tag must
match the one used on the instances created previously (VPN host).</p>
<ul>
<li>
<p>In the provider owned customer tenant, navigate to Cloud shell and
enter the following command to allow intervpc communication,
changing the &ldquo;&mdash;network=tenant1-transit&rdquo; to the customer&rsquo;s transit
network.</p>
<ul>
<li>gcloud compute firewall-rules create intervpc-communication1
--direction=INGRESS --priority=100 --network=tenant1-transit
--action=ALLOW --rules=all
--source-ranges=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,100.64.0.0/16
--target-tags=natgw</li>
</ul>
</li>
<li>
<p>Create a firewall rule for the NAT health check by running the
following command, changing the &ldquo;&mdash;network-tenant1-transit&rdquo; to the
name of the customer&rsquo;s transit network.</p>
<ul>
<li>gcloud compute firewall-rules create "natfirewall" --allow
tcp:80 --target-tags natgw --source-ranges
"209.85.152.0/22","209.85.204.0/22","35.191.0.0/16"
--network=tenant1-transit</li>
</ul>
</li>
<li>
<p>Click on Routes in the left pane and click CREATE ROUTE and enter
the following:</p>
<ul>
<li>
<p>Name: natgatewayout</p>
</li>
<li>
<p>Network: tenantname-transit</p>
</li>
<li>
<p>Destination IP range: 0.0.0.0/0</p>
</li>
<li>
<p>Priority: 50</p>
</li>
<li>
<p>Next Hope: Default internet gateway</p>
</li>
<li>
<p>Click CREATE</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve136.png alt="Graphical user interface, text, application Description
automatically
generated"></p>
</blockquote>
<ul>
<li>
<p>Click CREATE ROUTE and enter the following:</p>
<ul>
<li>
<p>Name: nat1</p>
</li>
<li>
<p>Network: tenantname-transit</p>
</li>
<li>
<p>Destination IP range: 0.0.0.0/0</p>
</li>
<li>
<p>Priority: 100</p>
</li>
<li>
<p>Instance tags: intravpcdefault</p>
</li>
<li>
<p>Next Hop: Specify an instance</p>
</li>
<li>
<p>Next Hop Instance: nat-1</p>
</li>
<li>
<p>Click CREATE</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve137.png alt="Table Description automatically generated with medium
confidence"></p>
</blockquote>
<ul>
<li>
<p>Create two more routes, one named nat2 and one nat3 with the same
priority of 100 and specify the next instance as nat-2 and nat-3
respectively for their routes as well as the same instance tag.</p>
</li>
<li>
<p>To test the functionality of the NAT VMs:</p>
<ul>
<li>
<p>Open an SSH session to each NAT VM and installing tcpdump with
&ldquo;sudo apt install tcpdump -y&rdquo;</p>
</li>
<li>
<p>On each host, run tcpdump with a filter set to the IP of a test
workload in GCVE with &ldquo;tcpdump -ni ens4 host ip_of_workload&rdquo;</p>
</li>
<li>
<p>On the GCVE workload, repeatedly curl a public URL such as
vmware.com and the traffic hits should spread across the three
NAT VMs.</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src=/images/cloud-infrastructure-cds-gcve/cloud-infrastructure-cds-gcve138.png alt="A picture containing calendar Description automatically
generated"></p>
</blockquote>
<h2 id=conclusion>
Conclusion
<a class=anchor href=#conclusion>#</a>
</h2>
<p>At this point, the VMware Cloud Director service Instance is ready to
deploy tenant VMs. For more information see the documentation for
<a href=https://docs.vmware.com/en/VMware-Cloud-Director-service/index.html>VMware Cloud Director
service</a>
and <a href=https://docs.vmware.com/en/VMware-Cloud-Director/index.html>VMware Cloud
Director</a>.</p>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments>
</div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
</main>
</body>
</html>