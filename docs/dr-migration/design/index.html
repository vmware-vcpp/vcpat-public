<!doctype html><html lang=en-us dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="DR and Migration Design #  Architecture #  The following diagram shows the network flow between the VMware Cloud Director Availability components and the other infrastructure components part of the replication process.
Other Components #  Platform Services Controller #  All the VMware Cloud Director Availability appliances need to be configured with a Lookup Service for two purposes:
 Service authentication and resource discovery – the Replicator and Management appliances require registration with a Lookup Service to authenticate to the resource vCenters and discover resources which is required for operations from the VMware Cloud Director Availability workflow.">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="DR and Migration Design">
<meta property="og:description" content="DR and Migration Design #  Architecture #  The following diagram shows the network flow between the VMware Cloud Director Availability components and the other infrastructure components part of the replication process.
Other Components #  Platform Services Controller #  All the VMware Cloud Director Availability appliances need to be configured with a Lookup Service for two purposes:
 Service authentication and resource discovery – the Replicator and Management appliances require registration with a Lookup Service to authenticate to the resource vCenters and discover resources which is required for operations from the VMware Cloud Director Availability workflow.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://vcpat.cloudhappens.io/docs/dr-migration/design/"><meta property="article:section" content="docs">
<meta property="article:modified_time" content="2022-07-06T11:50:11-04:00">
<title>DR and Migration Design | VMware Cloud Provider Architecture Toolkit</title>
<link rel=manifest href=/manifest.json>
<link rel=icon href=/favicon.png type=image/x-icon>
<link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous>
<script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.b5b5e29983ac1576e7ca1c2bc1dee915000a32635b0bae7311800b6ce3255660.js integrity="sha256-tbXimYOsFXbnyhwrwd7pFQAKMmNbC65zEYALbOMlVmA=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/><span>VMware Cloud Provider Architecture Toolkit</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
<ul>
<li><a href=/docs/cloud-infrastructure/><strong>Cloud Infrastructure</strong></a>
<ul>
<li><a href=/docs/cloud-infrastructure/planning/>Planning and Preparation</a></li>
<li><a href=/docs/cloud-infrastructure/design/>Design</a></li>
<li><a href=/docs/cloud-infrastructure/implementation/>Implementation</a></li>
<li><a href=/docs/cloud-infrastructure/operations/>Operations</a></li>
</ul>
</li>
<li><a href=/docs/networking-security/><strong>Networking & Security</strong></a>
<ul>
<li><a href=/docs/networking-security/planning/>Planning and Preparation</a></li>
<li><a href=/docs/networking-security/design/>Design</a></li>
<li><a href=/docs/networking-security/implementation/>Implementation</a></li>
<li><a href=/docs/networking-security/operations/>Operations</a></li>
</ul>
</li>
<li><a href=/docs/dr-migration/><strong>DR & Migration</strong></a>
<ul>
<li><a href=/docs/dr-migration/planning/>Planning and Preparation</a></li>
<li><a href=/docs/dr-migration/design/ class=active>Design</a></li>
<li><a href=/docs/dr-migration/implementation/>Implementation</a></li>
<li><a href=/docs/dr-migration/operations/>Operations</a></li>
</ul>
</li>
<li><a href=/docs/developer-ready-cloud/><strong>Developer Ready Cloud</strong></a>
<ul>
<li><a href=/docs/developer-ready-cloud/planning/>Planning and Preparation</a></li>
<li><a href=/docs/developer-ready-cloud/design/>Design</a></li>
<li><a href=/docs/developer-ready-cloud/implementation/>Implementation</a></li>
<li><a href=/docs/developer-ready-cloud/operations/>Operations</a></li>
</ul>
</li>
<li><a href=/docs/sovereign-cloud/><strong>Sovereign Cloud</strong></a>
<ul>
<li><a href=/docs/sovereign-cloud/planning/>Planning and Preparation</a></li>
<li><a href=/docs/sovereign-cloud/design/>Design</a></li>
<li><a href=/docs/sovereign-cloud/implementation/>Implementation</a></li>
<li><a href=/docs/sovereign-cloud/operations/>Operations</a>
<br></li>
</ul>
</li>
</ul>
<ul>
<li>
<a href=https://cloudsolutions.vmware.com target=_blank rel=noopener>
VMware Cloud Solutions
</a>
</li>
</ul>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>DR and Migration Design</strong>
<label for=toc-control>
</label>
</div>
</header>
<article class=markdown><h1 id=dr-and-migration-design>
DR and Migration Design
<a class=anchor href=#dr-and-migration-design>#</a>
</h1>
<h2 id=architecture>
Architecture
<a class=anchor href=#architecture>#</a>
</h2>
<p>The following diagram shows the network flow between the VMware Cloud Director Availability components and the other infrastructure components part of the replication process.</p>
<p><img src=/images/dr-migration/design/network-flow-in-vcda.png alt="VMware Cloud Director Availability Network Flow"></p>
<h2 id=other-components>
Other Components
<a class=anchor href=#other-components>#</a>
</h2>
<h3 id=platform-services-controller>
Platform Services Controller
<a class=anchor href=#platform-services-controller>#</a>
</h3>
<p>All the VMware Cloud Director Availability appliances need to be configured with a Lookup Service for two purposes:</p>
<ul>
<li>Service authentication and resource discovery – the Replicator and Management appliances require registration with a Lookup Service to authenticate to the resource vCenters and discover resources which is required for operations from the VMware Cloud Director Availability workflow.</li>
<li>Authentication to the VMware Cloud Director Availability service by the administrator which is not mandatory.
The Lookup Service has to be the one used by vCenters providing compute resources to VMware Cloud Director. For cases when the management and resource vCenters use different Lookup Services and the VMware Cloud Director Availability appliances are deployed at the management vCenter, they need to be configured with the Lookup Service of the resource vCenter(s) from/to which they will protect VMs/vApps.</li>
</ul>
<p>The Lookup Service and the associated Single Sign-On (SSO) domain is the boundary of a single VMware Cloud Director Availability instance. This is because a single Cloud Replication Management appliance can be registered with a single Lookup Service providing DR and migration services only for workloads in this SSO domain.
For cases when the cloud provider has multiple PVDCs in more than one SSO domain, a VMware Cloud Director Availability instance (tunnel, manager, replicators) needs to be deployed per each SSO domain.
It is possible to deploy a dedicated VMware Cloud Director Availability instance per PVDC, but one can protect as many PVDCs as exist in a single SSO domain.</p>
<h3 id=vcenter-server>
vCenter Server
<a class=anchor href=#vcenter-server>#</a>
</h3>
<p>VMware Cloud Director Availability needs to discover the workload VMs that need to be protected or migrated and destination resources (clusters, datastores, networks, etc.) for incoming replications and/or migrations in vCenters that are configured to provide the resources for VMware Cloud Director.</p>
<p>The Replicator is the component that communicates with the vCenter Servers. The tunnel has no such requirement.</p>
<h3 id=vmware-cloud-director>
VMware Cloud Director
<a class=anchor href=#vmware-cloud-director>#</a>
</h3>
<p>The integration with VMware Cloud Director is done through the Cloud Replication Management appliance.
The Cloud service communicates with VMware Cloud Director to discover the vApps/VMs for outgoing replications/migrations or destination resources (OrgVDC, network, storage) for incoming replications/migrations. VMware Cloud Director Availability uses the VMware Cloud Director API to request the information and initiate any operations.</p>
<br>
<p>As part of the initial setup, the administrator provides the VMware Cloud Director API HTTPS Base URL followed by /api and user account, which is a member of the System organization with its password. Then VMware Cloud Director Availability inspects the certificate presented by VMware Cloud Director. If the FQDN of the API HTTPS Base URL is not set as the Subject Alternative Name DNS entry, the registration cannot be completed. It is not enough to have this FQDN present in the certificate Common Name field. When a TLS connection to VMware Cloud Director is established and the authentication with the provided credentials is successful, VMware Cloud Director Availability uses the VMware Cloud Director REST API to discover its UI endpoint. Depending on its value, the VMware Cloud Director Availability HTTP server is dynamically reconfigured - the respective domain is added to the CORS allowlist.</p>
<br>
<p><strong>Additional Information:</strong> CORS is an HTTP mechanism that provides better security to end-users. Depending on how the server is configured, browsers may reject attempts to load resources from a server that is on domain A, but someone tries to load it in domain B. The VMware Cloud Director Availability Cloud service is set to allow only one VMware Cloud Director endpoint - the VMware Cloud Director UI endpoint or, if it is not configured, the API endpoint.
Once the certificate and credentials check are successful, VMware Cloud Director Availability deploys the files required for extension operation in the VMware Cloud Director cells.</p>
<h2 id=esxi-hosts>
ESXi hosts
<a class=anchor href=#esxi-hosts>#</a>
</h2>
<p>The Replicators communicate with hosts to:</p>
<ul>
<li>Configure the source VM for replication by enabling IO filter and configure it where to send replication data</li>
<li>Allocate resources in the host for the destination replication</li>
</ul>
<p>These operations are performed by the HBRsrv service. For authentication purposes, it needs to communicate to the hosts on port 80/tcp. For the data traffic, it uses 902/tcp to hosts to send the replication data (for incoming replications) and 44046/tcp from the hosts to receive replication data (for outgoing replications).</p>
<h2 id=data-paths>
Data Paths
<a class=anchor href=#data-paths>#</a>
</h2>
<p>Two appliances are responsible for the replication data path – the Replicator and the Tunnel. The Cloud Replication Management appliance does not handle any replication data.</p>
<h3 id=cloud-tunnel>
Cloud Tunnel
<a class=anchor href=#cloud-tunnel>#</a>
</h3>
<p>The Tunnel is a transparent proxy that is aware of the TLS protocol. It receives the incoming traffic and redirects it to the backend components based on its type. The management and HTTPS/API traffic is sent to the Cloud Replication Management, and the replication data traffic is sent to Replicator. It does not perform any operations on the replication traffic.
The Tunnel appliance does not consume significant compute resources, but in environments with many replications may handle a significant amount of network traffic. As it is published to the Internet via DNAT, it is recommended to connect it to a DMZ network where all the necessary security measures for such publish rules are taken.</p>
<h3 id=cloud-replicator>
Cloud Replicator
<a class=anchor href=#cloud-replicator>#</a>
</h3>
<p>The Replicator appliance runs three services – HBRsrv, LWDproxy, and Replicator.</p>
<br>
<p>The HBRsrv is a low-level component that communicates with the replication IO filter in ESXi hosts. The protocol used for communication is called LWD (Light Weight Delta) - a VMware proprietary protocol. This service is not aware of vCenter and does not communicate with it. The HBRsrv service is responsible for saving the VM deltas generated during the RPO window on the destination datastore. It is a common service for other VMware replication products, and VMware Cloud Director Availability reuses it for moving replication data at the last mile.
It configures the ESXi filter to send the replication traffic between the ESXi host and source Replicator in &ldquo;plain text&rdquo;. When the data is received by the source LWDproxy, it gets encrypted and optionally compressed. On the destination site, there&rsquo;s another LWDproxy that decrypts and decompresses the LWD traffic, and the destination Replicator sends the replication data to an ESXi host.</p>
<br>
<p>The LWDproxy is a VMware Cloud Director Availability service that ensures that replication traffic is sent to the Tunnel and is encrypted and compressed outside the local infrastructure. The LWDProxy service communicates with the Tunnel for sending/receiving replication data. Encryption and compression result in increased CPU utilization for the Replicator appliance. This may reduce the number of replications a single Replicator can handle.</p>
<br>
<p>The Replicator service is a VMware Cloud Director Availability management service that sends configuration instructions to the HBRsrv and LWDproxy services for every replication handled by the Replicator appliance. It understands the vCenter objects like hosts, VMs, datastores, etc. In this way, the Replicator discovers and prepares the source VMs for replication and creates objects (independent disks) for the incoming replications.
It is supposed there will be hundreds or thousands of VM replications/migrations in a cloud environment. Even if the number of replications is lower than the maximum supported handled by a single Replicator, it is highly recommended to deploy at least two or more replicators.
With several Replicators, the load generated by the replications can be spread over multiple hosts.
Balance the replication traffic on more physical uplinks and distribute the load better.
A single Replicator can be put in maintenance mode during a maintenance window without affecting replication traffic.</p>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments>
</div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
</main>
</body>
</html>